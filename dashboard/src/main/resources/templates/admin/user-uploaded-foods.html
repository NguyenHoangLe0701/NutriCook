<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::content}, 'Món ăn người dùng upload', 'Quản lý các món ăn được người dùng đăng tải', 'userUploadedFoods')}">

<div th:fragment="content">

    <!-- Search and Filter Bar -->
    <div class="mb-6 bg-white rounded-xl shadow-md p-6">
        <form th:action="@{/admin/user-uploaded-foods}" method="GET" class="flex flex-col md:flex-row gap-4">
            <!-- Search Input -->
            <div class="flex-1">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm</label>
                <div class="relative">
                    <input type="text" 
                           id="search" 
                           name="search" 
                           th:value="${search}"
                           placeholder="Tìm theo tên món ăn, email người upload, mô tả..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Filter Dropdown -->
            <div class="md:w-48">
                <label for="filter" class="block text-sm font-medium text-gray-700 mb-2">Lọc theo trạng thái</label>
                <select id="filter" 
                        name="filter" 
                        th:value="${filter}"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Tất cả</option>
                    <option value="approved">Đã duyệt</option>
                    <option value="pending">Chờ duyệt</option>
                    <option value="hidden">Đã ẩn</option>
                </select>
            </div>
            
            <!-- Submit Button -->
            <div class="flex items-end">
                <button type="submit" 
                        class="px-6 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-lg shadow-md hover:from-indigo-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105">
                    <i class="fa-solid fa-filter mr-2"></i>Tìm kiếm
                </button>
            </div>
            
            <!-- Clear Button -->
            <div class="flex items-end" th:if="${search != null and search != '' or filter != null and filter != ''}">
                <a th:href="@{/admin/user-uploaded-foods}" 
                   class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition-all duration-300">
                    <i class="fa-solid fa-times mr-2"></i>Xóa bộ lọc
                </a>
            </div>
        </form>
    </div>

    <!-- Flash Messages -->
    <div th:if="${success}" class="mb-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
        <i class="fa-solid fa-check-circle mr-2"></i><span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
        <i class="fa-solid fa-exclamation-circle mr-2"></i><span th:text="${error}"></span>
    </div>

    <!-- Table -->
    <div class="mt-8 flex flex-col">
        <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
                <div class="overflow-hidden shadow-lg ring-1 ring-indigo-200 md:rounded-2xl bg-white">
                    <table class="min-w-full divide-y divide-indigo-100">
                        <thead class="bg-gradient-to-r from-indigo-50 to-purple-50 border-b border-indigo-200">
                            <tr>
                                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-bold text-indigo-900 sm:pl-6">Ảnh</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Tên món ăn</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Người upload</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Calo</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Rating</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Trạng thái</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-bold text-indigo-900">Ngày upload</th>
                                <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                    <span class="sr-only">Hành động</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-indigo-100 bg-white">
                            <tr th:each="recipe : ${recipes}" class="hover:bg-indigo-50 transition-colors duration-200">
                                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                                    <div class="h-16 w-16 flex-shrink-0">
                                        <!-- Debug: Hiển thị URL nếu có (có thể xóa sau) -->
                                        <div th:if="${recipe.firstImageUrl != null and !#strings.isEmpty(recipe.firstImageUrl)}" 
                                             class="text-xs text-gray-400 mb-1 truncate" 
                                             th:title="${recipe.firstImageUrl}"
                                             style="max-width: 64px; overflow: hidden; text-overflow: ellipsis;">
                                        </div>
                                        <img class="h-16 w-16 rounded-lg object-cover border-2 border-gray-200" 
                                             th:src="${recipe.firstImageUrl != null and !#strings.isEmpty(recipe.firstImageUrl) ? recipe.firstImageUrl : '/images/default-food.svg'}" 
                                             th:alt="${recipe.recipeName}"
                                             th:data-original-url="${recipe.firstImageUrl}"
                                             onerror="console.error('Failed to load image:', this.getAttribute('data-original-url')); this.src='/images/default-food.svg';"
                                             loading="lazy">
                                    </div>
                                </td>
                                <td class="px-3 py-4 text-sm">
                                    <div class="font-medium text-gray-900" th:text="${recipe.recipeName}">Tên món ăn</div>
                                    <div class="text-gray-500 text-xs mt-1" th:text="${recipe.description} ?: 'Không có mô tả'" 
                                         th:if="${recipe.description != null and recipe.description != ''}">Mô tả</div>
                                    <div class="text-gray-400 text-xs mt-1" th:if="${recipe.estimatedTime != null}">
                                        <i class="fa-solid fa-clock mr-1"></i><span th:text="${recipe.estimatedTime}"></span>
                                    </div>
                                    <div class="text-gray-400 text-xs mt-1" th:if="${recipe.servings != null}">
                                        <i class="fa-solid fa-users mr-1"></i><span th:text="${recipe.servings}"></span>
                                    </div>
                                </td>
                                <td class="px-3 py-4 text-sm text-gray-900">
                                    <div th:if="${recipe.userEmail != null}">
                                        <div class="font-medium" th:text="${recipe.userEmail}">email@example.com</div>
                                        <div class="text-gray-500 text-xs" th:text="${recipe.userId}">User ID</div>
                                    </div>
                                    <div th:unless="${recipe.userEmail != null}" class="text-gray-400">N/A</div>
                                </td>
                                <td class="px-3 py-4 text-sm text-gray-500">
                                    <span th:text="${recipe.calories != null ? #numbers.formatDecimal(recipe.calories, 0, 'POINT', 0, 'POINT') : '0'}">0</span>
                                    <span class="text-gray-400">kcal</span>
                                </td>
                                <td class="px-3 py-4 text-sm">
                                    <div class="flex items-center gap-1">
                                        <span class="text-yellow-500">★</span>
                                        <span class="font-medium text-gray-900" th:text="${recipe.rating != null ? #numbers.formatDecimal(recipe.rating, 1, 'POINT', 1, 'POINT') : '0.0'}">0.0</span>
                                        <span class="text-gray-500 text-xs" th:text="'(' + ${recipe.reviewCount != null ? recipe.reviewCount : 0} + ')'">(0)</span>
                                    </div>
                                </td>
                                <td class="px-3 py-4 text-sm">
                                    <div class="flex flex-col gap-1">
                                        <span th:if="${recipe.approved != null and recipe.approved}" 
                                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fa-solid fa-check-circle mr-1"></i>Đã duyệt
                                        </span>
                                        <span th:if="${recipe.approved == null or !recipe.approved}" 
                                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <i class="fa-solid fa-clock mr-1"></i>Chờ duyệt
                                        </span>
                                        <span th:if="${recipe.available != null and !recipe.available}" 
                                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fa-solid fa-eye-slash mr-1"></i>Đã ẩn
                                        </span>
                                    </div>
                                </td>
                                <td class="px-3 py-4 text-sm text-gray-500" 
                                    th:text="${recipe.createdAt != null ? #temporals.format(recipe.createdAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/01/2024</td>
                                <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                    <div class="flex items-center justify-end gap-2">
                                        <!-- Toggle Approval Button -->
                                        <form th:action="@{/admin/user-recipes/{docId}/toggle-approval(docId=${recipe.docId})}" method="POST" class="inline-block">
                                            <button type="submit" 
                                                    class="inline-flex items-center justify-center rounded-lg px-3 py-2 font-bold text-white shadow-md transition-all duration-300 transform hover:scale-110"
                                                    th:classappend="${recipe.approved != null and recipe.approved} ? 'bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700' : 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700'"
                                                    th:title="${recipe.approved != null and recipe.approved} ? 'Hủy duyệt' : 'Duyệt'">
                                                <i class="fa-solid h-4 w-4" th:classappend="${recipe.approved != null and recipe.approved} ? 'fa-times' : 'fa-check'"></i>
                                                <span class="sr-only" th:text="${recipe.approved != null and recipe.approved} ? 'Hủy duyệt' : 'Duyệt'"></span>
                                            </button>
                                        </form>
                                        
                                        <!-- Nutrition Facts Button -->
                                        <button type="button" 
                                                class="nutrition-btn inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-blue-500 to-indigo-600 px-3 py-2 font-bold text-white shadow-md hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 transform hover:scale-110" 
                                                th:data-recipe-name="${recipe.recipeName}"
                                                th:data-calories="${recipe.calories != null ? recipe.calories : 0}"
                                                th:data-fat="${recipe.fat != null ? recipe.fat : 0}"
                                                th:data-carbs="${recipe.carbs != null ? recipe.carbs : 0}"
                                                th:data-protein="${recipe.protein != null ? recipe.protein : 0}"
                                                th:data-cholesterol="${recipe.cholesterol != null ? recipe.cholesterol : 0}"
                                                th:data-sodium="${recipe.sodium != null ? recipe.sodium : 0}"
                                                th:data-vitamin="${recipe.vitamin != null ? recipe.vitamin : 0}"
                                                onclick="showNutritionModal(this)"
                                                title="Xem dinh dưỡng">
                                            <i class="fa-solid fa-chart-pie h-4 w-4"></i>
                                            <span class="sr-only">Xem dinh dưỡng</span>
                                        </button>
                                        
                                        <!-- Toggle Availability Button -->
                                        <form th:action="@{/admin/user-recipes/{docId}/toggle-availability(docId=${recipe.docId})}" method="POST" class="inline-block">
                                            <button type="submit" 
                                                    class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-slate-500 to-slate-600 px-3 py-2 font-bold text-white shadow-md hover:from-slate-600 hover:to-slate-700 transition-all duration-300 transform hover:scale-110" 
                                                    th:title="${recipe.available != null and recipe.available} ? 'Ẩn' : 'Hiển thị'">
                                                <i class="fa-solid h-4 w-4" th:classappend="${recipe.available != null and recipe.available} ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                <span class="sr-only" th:text="${recipe.available != null and recipe.available} ? 'Ẩn' : 'Hiển thị'"></span>
                                            </button>
                                        </form>
                                        
                                        <!-- Delete Button -->
                                        <form th:action="@{/admin/user-recipes/{docId}/delete(docId=${recipe.docId})}" method="post" class="inline-block" onsubmit="return confirm('Bạn có chắc chắn muốn xóa công thức này? Hành động này không thể hoàn tác!');">
                                            <button type="submit" 
                                                    class="inline-flex items-center justify-center rounded-lg bg-gradient-to-r from-rose-500 to-red-600 px-3 py-2 font-bold text-white shadow-md hover:from-rose-600 hover:to-red-700 transition-all duration-300 transform hover:scale-110" 
                                                    title="Xóa">
                                                <i class="fa-solid fa-trash h-4 w-4"></i>
                                                <span class="sr-only">Xóa</span>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>

                            <tr th:if="${#lists.isEmpty(recipes)}">
                                <td colspan="8" class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 text-center">
                                    <div class="py-10">
                                        <i class="fa-solid fa-utensils fa-2x text-gray-400"></i>
                                        <h3 class="mt-2 text-sm font-medium text-gray-900">Chưa có món ăn nào được upload</h3>
                                        <p class="mt-1 text-sm text-gray-500">Người dùng chưa upload món ăn nào.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition Facts Modal -->
    <div id="nutritionModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeNutritionModal()"></div>

            <!-- Modal panel -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-gray-900" id="nutritionModalTitle">Thông tin dinh dưỡng</h3>
                        <button type="button" onclick="closeNutritionModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fa-solid fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <!-- Calories Circle -->
                    <div class="flex justify-center mb-6">
                        <div class="relative w-32 h-32">
                            <svg class="transform -rotate-90 w-32 h-32">
                                <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                                <circle id="caloriesCircle" cx="64" cy="64" r="56" stroke="#00BFA5" stroke-width="8" fill="none" 
                                        stroke-dasharray="351.86" stroke-dashoffset="351.86" 
                                        style="transition: stroke-dashoffset 1s ease-in-out;"></circle>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="caloriesValue" class="text-3xl font-bold text-gray-900">0</span>
                                <span class="text-sm text-gray-500">Calories</span>
                            </div>
                        </div>
                    </div>

                    <!-- Nutrition Cards -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <!-- Fat Card -->
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="fatValue">0g</div>
                            <div class="text-sm text-gray-600 mt-1">Chất béo</div>
                        </div>
                        <!-- Carbs Card -->
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="carbsValue">0g</div>
                            <div class="text-sm text-gray-600 mt-1">Tinh bột</div>
                        </div>
                        <!-- Protein Card -->
                        <div class="bg-teal-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-teal-600" id="proteinValue">0g</div>
                            <div class="text-sm text-gray-600 mt-1">Chất đạm</div>
                        </div>
                    </div>

                    <!-- Detailed Nutrition Facts -->
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Chi tiết dinh dưỡng</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-700">Cholesterol</span>
                                <span class="font-semibold text-gray-900" id="cholesterolValue">0 mg</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-700">Natri (Sodium)</span>
                                <span class="font-semibold text-gray-900" id="sodiumValue">0 mg</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-700">Vitamin</span>
                                <span class="font-semibold text-gray-900" id="vitaminValue">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-6 py-4 flex justify-end">
                    <button type="button" onclick="closeNutritionModal()" 
                            class="px-6 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold rounded-lg shadow-md hover:from-indigo-600 hover:to-purple-700 transition-all duration-300">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showNutritionModal(button) {
            const recipeName = button.getAttribute('data-recipe-name');
            const calories = parseFloat(button.getAttribute('data-calories')) || 0;
            const fat = parseFloat(button.getAttribute('data-fat')) || 0;
            const carbs = parseFloat(button.getAttribute('data-carbs')) || 0;
            const protein = parseFloat(button.getAttribute('data-protein')) || 0;
            const cholesterol = parseFloat(button.getAttribute('data-cholesterol')) || 0;
            const sodium = parseFloat(button.getAttribute('data-sodium')) || 0;
            const vitamin = parseFloat(button.getAttribute('data-vitamin')) || 0;

            // Update modal title
            document.getElementById('nutritionModalTitle').textContent = 'Thông tin dinh dưỡng: ' + recipeName;

            // Update calories
            document.getElementById('caloriesValue').textContent = Math.round(calories);
            
            // Update calories circle (assuming 2000 is max calories)
            const maxCalories = 2000;
            const caloriesPercent = Math.min(calories / maxCalories, 1);
            const circumference = 2 * Math.PI * 56; // radius = 56
            const offset = circumference * (1 - caloriesPercent);
            const circle = document.getElementById('caloriesCircle');
            circle.style.strokeDashoffset = offset;

            // Update nutrition values
            document.getElementById('fatValue').textContent = fat.toFixed(1) + 'g';
            document.getElementById('carbsValue').textContent = carbs.toFixed(1) + 'g';
            document.getElementById('proteinValue').textContent = protein.toFixed(1) + 'g';
            document.getElementById('cholesterolValue').textContent = Math.round(cholesterol) + ' mg';
            document.getElementById('sodiumValue').textContent = Math.round(sodium) + ' mg';
            document.getElementById('vitaminValue').textContent = Math.round(vitamin) + '%';

            // Show modal
            document.getElementById('nutritionModal').classList.remove('hidden');
        }

        function closeNutritionModal() {
            document.getElementById('nutritionModal').classList.add('hidden');
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeNutritionModal();
            }
        });
    </script>
</div>
</html>
